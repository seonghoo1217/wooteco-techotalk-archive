# queydsl ì‚¬ìš© ë°°ê²½
ë°°ë‹¬ì˜ ë¯¼ì¡± ì–´í”Œì„ í†µí•´ 1ê°œì˜ ì£¼ë¬¸ì„ ë°œìƒì‹œí‚¬ ê²½ìš° ì •ì‚°ì‹œìŠ¤í…œ DBì—ëŠ” ì´ 3ê°œì˜ í…Œì´ë¸”ì´ ì‘ë™í•œë‹¤.

- 1ê°œì˜ ì£¼ë¬¸ì •ë³´ì™€ Nê°œì˜ ê²°ì œ ì •ë³´ê°€ ì¡´ì¬í•œë‹¤.
- 0ê°œì—ì„œ Nê°œì˜ í• ì¸ì •ë³´ê°€ ë§¤í•‘ëœë‹¤.

![img.png](img/wooa_db.png)

ì´ë•Œ ì£¼ë¬¸ê³¼ ê²°ì œ í…Œì´ë¸”ì—ëŠ” 10ì–µê°œì—ì„œ 13ì–µê°œì˜ ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤.
ì´ë ‡ë“¯ ì ì¬ëœ ë°ì´í„°ê°€ 1000ë§Œê±´ì—ì„œ 10ì–µê±´ê¹Œì§€ ì•„ì£¼ í° ìˆ˜ë¥¼ ì°¨ì§€í•˜ê³  ìˆì„ ë•Œ,  querydslì„ ê°œì„ í•˜ì—¬ ì‚¬ìš©í•˜ëŠ”ë°©ë²•ì— ëŒ€í•´ ë‹¤ë£¨ê²Œ ë˜ì—ˆë‹¤.

[ëª©ì°¨]
-
- ì›Œë°ì—…
- ì„±ëŠ¥ê°œì„  - select
- ì„±ëŠ¥ê°œì„  - update/insert
- ë§ˆë¬´ë¦¬

## 1. extends/implements ì‚¬ìš©í•˜ì§€ ì•Šê¸°(ì›Œë°ì—…)

ì²«ë²ˆì§¸ íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œëŠ” ìƒì†ê³¼ êµ¬í˜„ì„ ì‚¬ìš©í•˜ì§€ì•ŠëŠ”ë‹¤. 

![img.png](img/extends.png)

ë³´í†µì ìœ¼ë¡œ querydslì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„  JPARepositoryë¥¼ ìƒì†ë°›ê³  CustomRepositoryë¥¼ë§Œë“¤ì–´
Interfaceë¥¼ extendsí•˜ê³  Implì„ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ì„ í˜¸í•œë‹¤.

í•˜ì§€ë§Œ, ì´ì— ë”°ë¼ í•˜ë‚˜ì˜ Entityì— ìƒê²¨ë‚˜ëŠ” ê°ì²´ê°€ ìµœì†Œ 2ê°œì´ë©° ë¶ˆí•„ìš”í•œ ìƒì†ê³¼ í™•ì¥ì„ ë‚¨ìš©í•˜ê²Œ ëœë‹¤.

ì´ì— ê³¼í•¨ì„ ëŠë¼ê³  QuerydslSuportë¥¼ ìƒì†ë°›ëŠ” êµ¬ì¡°ì²´ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ,
ë§¤ë²ˆ Supportì„ ìƒì†í•˜ê³  super ìƒì„±ìì— Entityë¥¼ ë“±ë¡í•´ì•¼í•œë‹¤ëŠ” ë²ˆê±°ë¡œì›€ì´ ì¡´ì¬í•œë‹¤.

ê·¸ëŸ¼ ì—¬ê¸°ì„œ ìš°ë¦¬ëŠ” í•œê°€ì§€ ìƒê°ì„ í•  ìˆ˜ ìˆë‹¤.
> ê¼­ ë¬´ì–¸ê°€ë¥¼ **ìƒì†/êµ¬í˜„** ë°›ì§€ ì•Šë”ë¼ë„, ê¼­ **íŠ¹ì • Entityë¥¼** ì§€ì •í•˜ì§€ ì•Šë”ë¼ë„ querydslì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì—†ì„ê¹Œ?

ì´ë¥¼ ì¶©ì¡±í•˜ëŠ” ë°©ë²•ì€ JPAQueryFactoryë¥¼ ì‚¬ìš©í•˜ì—¬ querydslì„ ì‚¬ìš©í•˜ëŠ”ë° ë¬¸ì œê°€ ì—†ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
ìƒì†/êµ¬í˜„ êµ¬ì¡°ë¥¼ íƒˆí”¼í•  ìˆ˜ ìˆë‹¤.

**QueryDslì‚¬ìš©ë°©ë²•**
```java
// ê¸°ì¡´ ë°©ë²• 1. 
public interface MemberRepository extends JpaRepository<Member, Long>, MemberRepositoryCustom {} 


// ê¸°ì¡´ ë°©ë²•2
public class MemberRepositoryCustom extends QuerydslRepositorySupport {}

// ì¶”ì²œí•˜ëŠ” ë°©ë²•
@Repository
@RequiredArgsConstructor 
public class MemberRepositoryCustom {
    private final JpaQueryFactory queryFactory; // ë¬¼ë¡  ì´ë¥¼ ìœ„í•´ì„œëŠ” ë¹ˆìœ¼ë¡œ ë“±ë¡ì„ í•´ì¤˜ì•¼ í•œë‹¤. 
}
```

**JpaQueryFactory ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ë°©ë²•**
```java
@Configuration
public class QuerydslConfiguration {
    @Autowired
    EntityManager em;

    @Bean
    public JPAQueryFactory jpaQueryFactory() {
       return new JPAQueryFactory(em);
    }
}
```

![img.png](img/queryFactory.png)

## 2. ë™ì ì¿¼ë¦¬(ì›Œë°ì—…)

ë™ì ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ëŠ” ë°©ë²•ì—ëŠ” BooleanBuilder ë¥¼ ì‘ì„±í•˜ëŠ” ë°©ë²•ê³¼ Where ì ˆê³¼ í”¼ë¼ë¯¸í„°ë¡œ Predicate ë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²• ê·¸ë¦¬ê³  Where ì ˆê³¼ í”¼ë¼ë¯¸í„°ë¡œ Predicate ë¥¼ ìƒì†í•œ BooleanExpression ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²• ì´ë ‡ê²Œ ìˆë‹¤.

ì˜ˆì œë¥¼ ë³´ë©´ ì•Œê² ì§€ë§Œ BooleanBuilder ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ì–´ë–¤ ì¿¼ë¦¬ê°€ ë‚˜ê°€ëŠ”ì§€ ì˜ˆì¸¡í•˜ê¸° í˜ë“¤ë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤.

ê·¸ë¦¬ê³  Predicate ë³´ë‹¤ëŠ” BooleanExpression ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ë¡œëŠ” BooleanExpression ì€ and ì™€ or ê°™ì€ ë©”ì†Œë“œë“¤ì„ ì´ìš©í•´ì„œ
BooleanExpression ì„ ì¡°í•©í•´ì„œ ìƒˆë¡œìš´ BooleanExpression ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤.

ê·¸ëŸ¬ë¯€ë¡œ ì¬ì‚¬ìš©ì„±ì´ ë†’ë‹¤. ê·¸ë¦¬ê³  BooleanExpression ì€ null ì„ ë°˜í™˜í•˜ê²Œ ë˜ë©´ Where ì ˆì—ì„œ ì¡°ê±´ì´ ë¬´ì‹œë˜ê¸° ë•Œë¬¸ì— ì•ˆì „í•˜ë‹¤.

ëŒ€ë¶€ë¶„ ë™ì  ì¿¼ë¦¬ì˜ ì‚¬ìš©ì„ ìœ„í•´ BooleanBuilderë¥¼ ëŒ€ë¶€ë¶„ ì‚¬ìš©í•˜ê³  ê¸°ëŠ¥ì ìœ¼ë¡œ ë¬¸ì œëŠ” ì—†ë‹¤.
í•˜ì§€ë§Œ ì–´ë–¤ ì¿¼ë¦¬ì¸ì§€ ì˜ˆìƒí•˜ê¸° ì–´ë µë‹¤.

**BooleanBuilder ë¥¼ ì´ìš©í•˜ëŠ” ì˜ˆì œ**

```java
public List<MemberTeamDto> searchByBuilder(MemberSearchCondition condition){
    BooleanBuilder builder = new BooleanBuilder();

    if (hasText(condition.getUsername())) {
        builder.and(member.username.eq(condition.getUsername()));
    }

    if(hasText(condition.getTeamName())){
        builder.and(team.name.eq(condition.getTeamName()));
    }

    if(condition.getAgeGoe() != null) {
        builder.and(member.age.goe(condition.getAgeGoe()));
    }

    if(condition.getAgeLoe() != null){
        builder.and(member.age.loe(condition.getAgeLoe()));
    }

    return queryFactory
            .select(new QMemberTeamDto(
                    member.id.as("memberId"),
                    member.username,
                    member.age,
                    team.id.as("teamId"),
                    team.name.as("teamName")
            ))
            .from(member)
            .leftJoin(member.team, team)
            .where(builder)
            .fetch();
}
```
**Where ì ˆê³¼ BooleanExpression ì„ ì´ìš©í•˜ëŠ” ì—ì œ**
```java
public List<MemberTeamDto> searchByWhere(MemberSearchCondition condition){
    return queryFactory
            .select(new QMemberTeamDto(
                    member.id.as("memberId"),
                    member.username,
                    member.age,
                    team.id.as("teamId"),
                    team.name.as("teamName")
            ))
            .from(member)
            .leftJoin(member.team, team)
            .where(
                usernameEq(condition.getUsername()),
                teamNameEq(condition.getTeamName()),
                ageGoe(condition.getAgeGoe()),
                ageLoe(condition.getAgeLoe())
            )
            .fetch();
}

private BooleanExpression usernameEq(String username) {
    return hasText(username) ? member.username.eq(username) : null;
}

private BooleanExpression teamNameEq(String teamName) {
    return hasText(teamName) ? team.name.eq(teamName) : null;
}

private BooleanExpression ageGoe(Integer ageGoe) {
    return ageGoe != null ? member.age.goe(ageGoe) : null;
}

private BooleanExpression ageLoe(Integer ageLoe) {
    return ageLoe != null ? member.age.loe(ageLoe) : null;
}

private BooleanExpression ageBetween(Integer ageLoe, Integer ageGoe) {
    return ageLoe(ageLoe).and(ageGoe(ageGoe));
}
```

![img.png](img/select_min.png)

ì´ë¥¼ ë³´ì™„í•˜ê¸° ìœ„í•´ BooleanExpressionì„ ì´ìš©í•œë‹¤.
ë©”ì„œë“œ ë‹¨ìœ„ë¡œ ë§Œë“¤ì–´ nullì„ ë°˜í™˜í•  ê²½ìš° ìë™ìœ¼ë¡œ ì¡°ê±´ì ˆì—ì„œ ì œê±°ëœë‹¤.

ëª¨ë“  ì¡°ê±´ì— nullì´ ë°˜í™˜ë˜ëŠ” ê²½ìš°ì—ëŠ” ì„œë²„ì— ëŒ€ëŒ€ì ì¸ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

## ì„±ëŠ¥ê°œì„  - Select (Main.1)

### querydslì—ì„œì˜ exist ê¸ˆì§€(select ì„±ëŠ¥ê°œì„ í•˜ê¸°) (Main.1-1)

existëŠ” ì„œë¸Œì¿¼ë¦¬ì˜ ê°’ì˜ ìœ ë¬´ë§Œì„ íŒë‹¨í•˜ëŠ” ë©”ì†Œë“œë¡œ ë§Œì•½ í•œê±´ì´ë¼ë„ ìˆë‹¤ë©´ ì¿¼ë¦¬ë¥¼ ì¤‘ì§€í•˜ê²Œ ëœë‹¤.


**ì˜ˆì‹œ**

![img.png](img/exist.png)

2500ë§Œê±´ì„ ê¸°ì¤€ìœ¼ë¡œ SQL ì¿¼ë¦¬ì—ì„œ existì™€ count ì¿¼ë¦¬ë¥¼ ë¹„êµí•œ ê²ƒì´ë‹¤.

existë¥¼ ì‚¬ìš©í•˜ë©´ ì‹œê°„ì´ countì— ë¹„í•´ 50%ì˜ ë›°ì–´ë‚œ ì„±ëŠ¥ì„ ë³´ì´ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
ì´ëŠ” existê°€ íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” rowì˜ ìœ ë¬´ë¥¼ íŒë‹¨í•˜ëŠ” ëŠ¥ë ¥ì´ ë” ë›°ì–´ë‚˜ê¸° ë•Œë¬¸ì´ë‹¤.

ë” ë›°ì–´ë‚˜ë‹¤ëŠ” ê²ƒì€ existì˜ ê²½ìš° ì•ì„œë§í–ˆë“¯ì´ í•œê±´ì„ ì°¾ëŠ” ìˆœê°„ ë°”ë¡œ ì¤‘ì§€ë˜ê¸° ë–„ë¬¸ì— ë” ë¹ ë¥¸ì†ë„ë¥¼ ë³´ì¥í•œë‹¤.

í•˜ì§€ë§Œ ì´ëŠ” ì°¾ê³ ì í•˜ëŠ”(ìŠ¤ìº” ëŒ€ìƒ)ì˜ ë°ì´í„° ìœ„ì¹˜ì— ë”°ë¼ ì„±ëŠ¥ì˜ ì°¨ì´ê°€ ì‹¬í•˜ê²Œ ì°¨ì´ë‚˜ê²Œ ëœë‹¤.

countì˜ ê²½ìš° ëª¨ë“  ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë©° ì¡°ê±´ì— ë¶€í•©í•˜ëŠ” rowë§Œì„ ìƒ‰ì¶œí•˜ëŠ” ë°˜ë©´
existëŠ” ë°œê²¬í•  ë•Œ ê¹Œì§€ ì¡°íšŒ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸°ì— ë°ì´í„°ì˜ ìœ„ì¹˜ì— ë”°ë¼ ì„±ëŠ¥ì´ ì°¨ì´ë‚œë‹¤.

![img.png](img/exist2.png)


ë˜í•œ, querydslì˜ existëŠ” ì‹¤ì œë¡œ sqlì˜ existê°€ ì•„ë‹Œ countë¥¼ í† ëŒ€ë¡œ êµ¬í˜„ì´ ë˜ì–´ìˆê¸° ë•Œë¬¸ì— ì•ì„œ ì„±ëŠ¥ìƒìœ¼ë¡œ ë¬¸ì œê°€ ë˜ì—ˆë˜ countë¥¼ ì´ìš©í•˜ëŠ” ë§Œí¼
ì„±ëŠ¥ì´ ì¢‹ì§€ ëª»í•˜ê²Œ ëœë‹¤.

**Querydsl ë‚´ë¶€ exists êµ¬í˜„ ìƒíƒœ - QuerydslJpaPredicateExecutor.class**

```java
public boolean exists(Predicate predicate) {
    return this.createQuery(predicate).fetchCount() > 0L; // ë³´ì‹œë‹¤ì‹œí”¼ count ë¡œ ì¡°íšŒí•œë‹¤.
}
```

ë˜í•œ sqlì˜ ê·¼ê°„ì´ ë˜ëŠ” ì¡°íšŒì‘ì—…ì‹œ fromì ˆ ì—†ì´ëŠ” ì¡°íšŒì‘ì—…ì´ ìˆ˜í–‰ë  ìˆ˜ ì—†ëŠ” ì´ìŠˆ ë˜í•œ ì¡´ì¬í•˜ê¸°ì—
exist ì‚¬ìš©ì„ ì§€ì–‘í•´ì•¼í•œë‹¤.

**existê°€ ë¹ ë¥¸ ì´ìœ ëŠ”?**
ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” row 1ê°œë§Œ ì°¾ìœ¼ë©´ ë°”ë¡œ ì¿¼ë¦¬ë¥¼ ì¢…ë£Œí•˜ê¸° ë•Œë¬¸ì´ë‹¤.
í•˜ì§€ë§Œ, ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•œ ì´ìŠˆê°€ ì¡´ì¬í•œë‹¤.
ê·¸ë ‡ë‹¤ë©´? `ì§ì ‘ êµ¬í˜„`í•˜ì—¬ ì‚¬ìš©í•˜ì

### exist ì§ì ‘êµ¬í˜„í•˜ê¸° (Main.1-2)

existë¥¼ ì§ì ‘êµ¬í˜„í•˜ëŠ”ë° ìˆì–´ ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì€ limit 1ë¡œ ì¡°íšŒì‘ì—…ì„ ì§„í–‰í•œë‹¤.

```java
@Transactional(readOnly=true)
public Boolean exist(Long entity_seq){
    Integer fetchOne = queryFactory
        .selectOne()
        .from(entity)
        .where(entity.seq.eq.(entity_seq))
        .fetchFirst();
    
    return fetchOne != null; //ì¡°íšŒ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° nullì´ ë°˜í™˜ë˜ê¸°ì— ì²´í¬ì‘ì—…ì„ ìˆ˜í–‰
}
```

ìœ„ì˜ ì½”ë“œì—ì„œ fetchFirstë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ `fetchFirst()`ê°€ `limit(1).fetchOne()`ì„ ë³´ì¥í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

## ì§ì ‘ êµ¬í˜„ ê²°ê³¼

![img.png](img/result_exist.png)

ì›ë˜ ì‚¬ìš©í•˜ë˜ existë³´ë‹¤ ì¡°ê¸ˆ ë” ê°œì„ ëœ ì„±ëŠ¥ì„ ë³´ì—¬ì£¼ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.


### Cross Join íšŒí”¼í•˜ê¸°(select ì„±ëŠ¥ê°œì„ í•˜ê¸°) (Main.1-3)

Joinì‹œ CrossJoin(ìƒí˜¸ì¡°ì¸)ì„ ì‚¬ìš©í•˜ë©´ ë‹¹ì—°íˆ ì†ë„ì ì¸ ì¸¡ë©´ì˜ ì„±ëŠ¥ìƒ ì´ì ì„ ê°€ì§€ì§„ ì•ŠëŠ”ë‹¤.
CrossJoinì˜ ê²½ìš° ë‚˜ì˜¬ ìˆ˜ ìˆëŠ” ëª¨ë“  ê²½ìš°ì˜ ìˆ˜ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

ì´ë•Œ joinì„ ì‚¬ìš©í•˜ì§€ ì•Šë”ë¼ë„ ë¬µì‹œì  Joinìœ¼ë¡œ Cross Joinì´ ë°œìƒí•œë‹¤. 

ex) ë§Œì•½ Customerë¼ëŠ” Entity ë‚´ë¶€ì— Shopì´ë¼ëŠ” Entityê°€ Relation Mappingì´ ë˜ì–´ìˆê³  ì´ë¥¼ where ì ˆì—ì„œ ì‚¬ìš©í•  ê²½ìš° ë¬µì‹œì  Joinì´ ë°œìƒí•œë‹¤.

ì´ëŸ¬í•œ ì´ìŠˆëŠ” querydslì´ ì•„ë‹ˆë”ë¼ë„ Native Query ë˜ëŠ” Spring Data Jpaì—ì„œë„ ë™ì¼ ì´ìŠˆê°€ ë°œìƒí•œë‹¤.(Hibernate ì´ìŠˆì´ê¸° ë•Œë¬¸)

> ğŸ’¡ ë¬µì‹œì  ì¡°ì¸
>
> fromì ˆì—ì„œ ì¡°ì¸ ê´€ê³„ë¥¼ ë”°ë¡œ ëª…ì‹œí•˜ì§„ ì•ŠëŠ”ë‹¤. selectì ˆì—ì„œ ì˜ì¡´ì„±ì„ ê°€ì§€ëŠ” ë‹¤ë¥¸ ì—”í‹°í‹° ê°ì²´ë¥¼ ì¡°íšŒí•˜ë ¤ í•  ê²½ìš° JPAê°€ ì•Œì•„ì„œ PK, FKë¥¼ ê°€ì§€ê³  í•´ë‹¹ í…Œì´ë¸”ê³¼ inner joinì„ ìˆ˜í–‰í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì¤€ë‹¤.
>
> ë‹¹ì—°í•œ ì´ì•¼ê¸°ì§€ë§Œ ë¬µì‹œì  ì¡°ì¸ì—ì„œëŠ” inner joinë§Œ ê°€ëŠ¥í•˜ë‹¤. outter joinì„ í•˜ë ¤ë©´ ë§Œë“œì‹œ ëª…ì‹œì  ì¡°ì¸ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤

### Cross Joinì„ íšŒí”¼í•˜ëŠ” ë°©ë²•(Main.1-4)

ì •ë§ ê°„ë‹¨í•˜ê²Œ ì´ìŠˆë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ”ë° joinì„ ëª…ì‹œì ìœ¼ë¡œ ì„ ì–¸í•˜ì§€ ì•Šì•„ ë¬µì‹œì  ì¡°ì¸ì´ ë°œìƒí•˜ê³  ì´ë•Œ Cross Joinì´ ë°œìƒí•œë‹¤.
ê·¸ë ‡ë‹¤ë©´ ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ innerJoinì„ ëª…ì‹œì ìœ¼ë¡œ ì‘ì„±í•´ì¤„ ê²½ìš° Cross Joinì´ ë°œìƒí•˜ì§€ ì•Šì„ ë¿ë”ëŸ¬ Entity í•˜ë‚˜ì—ë§Œ Joinì´ ë°œìƒí•˜ê²Œ ëœë‹¤.


### Entity ë³´ë‹¤ëŠ” DTOë¥¼ ìš°ì„ ì‹œ(select ì„±ëŠ¥ê°œì„ í•˜ê¸°) (Main.1-5)

JPAì˜ í™˜ê²½ì—ì„œ EntityëŠ” ë‹¹ì—°íˆ ì¤‘ìš”í•œ ê°€ì¹˜ë¥¼ ê°€ì§€ì§€ë§Œ DBì™€ ì§ì ‘ ì—°ê²°ë˜ëŠ” ê°ì²´ì¸ ë§Œí¼ ìˆ˜ì • ë° ì‚½ì…ì˜ ì‘ì—…ì— ì‹ ì¤‘í•´ì•¼í•œë‹¤.

ì´ë¥¼ DTOë¥¼ ì‚¬ìš©í•˜ì—¬ Entity ìì²´ì˜ ë¶€ë‹´ì„ ëœ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ì¡´ì¬í•œë‹¤.

quertdslì—ì„œ Entityë¥¼ ì¡°íšŒí•˜ê²Œ ê²½ìš° í¬ê²Œ 3ê°€ì§€ ë¬¸ì œê°€ ì¡´ì¬í•œë‹¤.

1. Hibernate 1ì°¨, 2ì°¨ ìºì‹œ ì´ìŠˆ
2. ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ ì¡°íšŒ
3. OneToOne Relation ì‹œ N+1 ì¿¼ë¦¬ ë°œìƒ

### ğŸ¤” ì™œ DTOë¥¼ ì¡°íšŒí•´ì•¼í• ê¹Œ?

**Entity ì¡°íšŒ Case**
- ì‹¤ì‹œê°„ìœ¼ë¡œ Entity ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš°

**DTO ì¡°íšŒ**
- ê³ ê°•ë„ ì„±ëŠ¥ ê°œì„  or ëŒ€ëŸ‰ì˜ ë°ì´í„° ì¡°íšŒê°€ í•„ìš”í•œ ê²½ìš°

ì¦‰, ì§ì ‘ì ìœ¼ë¡œ Entityì— ìƒíƒœë³€í™”ë¥¼ ì¼ìœ¼í‚¤ëŠ” ë¡œì§ì´ ì•„ë‹ ê²½ìš°(ì¡°íšŒ ì‘ì—…ì— í•œí•  ê²½ìš°) DTOë¥¼ ì¡°íšŒí•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ì ìœ¼ë¡œ ì´ì ì´ ì¡´ì¬í•œë‹¤.

### ì¡°íšŒ ì»¬ëŸ¼ ìµœì†Œí™” í•˜ê¸°(Main.1-6)

**ì´ë¯¸ ì•Œê³  ìˆëŠ” ê°’(ex. ì¸ìê°’ìœ¼ë¡œ ë„˜ì–´ ì˜¨ê°’ ë˜ëŠ” ì „ì—­ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ê°’)**ì„ ì¡°íšŒ ì¿¼ë¦¬ì— í¬í•¨ì‹œí‚¤ì§€ ì•ŠëŠ”ë‹¤.

![img.png](img/select_min.png)

ìœ„ì˜ ì˜ˆì œ ì‚¬ì§„ì„ ë³¸ë‹¤ë©´ ì´ë¯¸ ì„ ì–¸ëœ ê°’ì„ ì¡°íšŒ ì¿¼ë¦¬ì— í¬í•¨ì‹œì¼œ ë¶ˆí•„ìš”í•œ ì¡°íšŒ ì‘ì—…ì´ í•œë²ˆ ë” ì´ë£¨ì–´ì§€ê²Œ ëœë‹¤.

í•˜ì§€ë§Œ í•´ë‹¹ í•„ë“œ ê°’ì„ í† ëŒ€ë¡œ ì¡°íšŒì‘ì—…ì€ ê²°êµ­ì— select ì ˆì—ëŠ” í¬í•¨ì´ ë˜ì–´ì•¼í•œë‹¤. 

**ì´ë¥¼ ì–´ë–»ê²Œ ëŒ€ì²´í•  ìˆ˜ ìˆëŠ”ê°€?**

ì¡°íšŒ ì ˆì— `as í‘œí˜„ì‹`ì„ ì‚¬ìš©í•˜ì—¬ ëŒ€ì²´í•  ìˆ˜ ìˆë‹¤.(Expressionì„ ì‚¬ìš©í•˜ì—¬ boolean ê°’ìœ¼ë¡œ return ë°›ì•„ ì‚¬ìš©í•˜ê²Œ ëœë‹¤ë©´, ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.)

![img.png](img/expression_as.png)

### Select ì»¬ëŸ¼ì— Entity ìì œí•˜ê¸°(Main.1-7)

![img.png](img/select_entity.png)

ìœ„ ì˜ˆì œ ì‚¬ì§„ê³¼ ê°™ì´, Owner Entity(selectì˜ ì£¼ì¸ì´ ë˜ëŠ” Entity)ë¥¼ Select í•˜ê²Œë˜ë©´ 
Target Entity(ì—°ê´€ ê´€ê³„ê°€ ë§ºì–´ì ¸ ì¡°íšŒì‹œ í•„ìš”í•œ ì—”í‹°í‹°)ë¥¼ í•„ë“œê°’ìœ¼ë¡œ ì¡°íšŒí•  ë•Œ, ì¡°íšŒëœ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ ê·œ Entityë¥¼ ìƒì„±í•˜ê²Œëœë‹¤.

í•˜ì§€ë§Œ ì´ê²½ìš° Target Entityì˜ ëª¨ë“  í•„ë“œê°’ì´ ì¡°íšŒ ë˜ê²Œ ëœë‹¤. 

ì˜ˆë¥¼ ë“¤ì–´ Target Entityì˜ PKë§Œì„ í•„ìš”ë¡œ í•  ê²½ìš°, ì´ ì™¸ì˜ í•„ë“œ ê°’ ë˜í•œ ì¡°íšŒë˜ê¸° ë•Œë¬¸ì— ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ì´ ì¡°íšŒëœë‹¤.

ì—¬ê¸°ì„œ ì•ì„œ ë§í•œ `@OneToOne` ë§¤í•‘ ê´€ê³„ì¼ ê²½ìš°ì˜ ì´ìŠˆê°€ ë°œìƒí•˜ê²Œëœë‹¤.

### @OneToOne ì´ìŠˆ?(Main.1-7-1)
@OneToOneì€ JPAì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¡œë”©ì „ëµ ê¸°ë²•ì¤‘ `LAZY Loading` ì „ëµì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì¡°íšŒì‹œì ì—ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜í•´ 1:1ë¡œ ë§¤í•‘ëœ Entityì˜ ëª¨ë“  í•„ë“œ ê°’ì„ ë˜ ì¡°íšŒí•œë‹¤.

ê·¸ëŸ¼ ìš°ë¦¬ëŠ” ì—¬ê¸°ì„œ ìµœì•…ì˜ ê²½ìš°ë¥¼ ìƒì •í•´ ë³¼ ìˆ˜ ìˆë‹¤.

**í˜„ì¬ `@OneToOne` ë§¤í•‘ìœ¼ë¡œ ì¸í•´ ë¶ˆëŸ¬ì™€ì§€ëŠ” Entity ë˜í•œ ë‹¤ë¥¸ Entityì™€ @OneToOneìœ¼ë¡œ ë§¤í•‘ë˜ì–´ìˆë‹¤ë©´?**

ë˜ ë‹¤ì‹œ í•´ë‹¹ ì—”í‹°í‹° ì „ë¶€ë¥¼ ê°€ì ¸ì˜¤ê²Œ ë˜ë¯€ë¡œ ë¶ˆí•„ìš”í•œ ì¡°íšŒê°€ ìˆ˜ë„ ì—†ì´ ì¼ì–´ë‚  ìˆ˜ ìˆë‹¤.

![img.png](img/selectOne.png)


### Entity ìì œì‹œ ì €ì¥ì— ëŒ€í•œ ê³ ë¯¼(Main.1-7-2)

**ğŸ¤” Entityê°„ì˜ ì—°ê´€ê´€ê³„ë¥¼ ë§ºê¸° ìœ„í•´ì„  Entityê°€ í•„ìš”í•œ ê²ƒì•„ë‹Œê°€?**
í•„ì ë˜í•œ ì´ ìƒê°ì„ ê°€ì¥ ë¨¼ì €í•˜ê²Œ ë˜ì—ˆë‹¤.

í•˜ì§€ë§Œ ì—°ê´€ëœ Entityì˜ saveë¥¼ ìœ„í•´ì„  ë°˜ëŒ€í¸ Entityì˜ PK, ì¦‰ IDë§Œ ì¡´ì¬í•˜ë©´ëœë‹¤.

í•œë§ˆë””ë¡œ Join columnì— ë“¤ì–´ê°ˆ IDë§Œ í•„ìš”í•œê²ƒì´ë‹¤.

ë‚´ë¶€ì ìœ¼ë¡œëŠ” ì´ ê³¼ì •ì´ Entityì˜ ë‚˜ë¨¸ì§€ columnê°’ì„ distinct ì‹œì¼œë²„ë¦°ë‹¤.

## Main.1 Reference

### Hibernate ìºì‹œ ì´ìŠˆ

HibernateëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—”í‹°í‹° ê°ì²´ì˜ ìƒíƒœë¥¼ ì¶”ì í•˜ê³  ìºì‹±í•œë‹¤.
ë§Œì•½ ë™ì¼í•œ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ìˆ˜ì •í•˜ë ¤ê³  í•  ë•Œ, ì´ì „ì— ì¡°íšŒí•œ ì—”í‹°í‹° ê°ì²´ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìºì‹±ë˜ì–´ ìˆë‹¤ë©´, ìƒˆë¡œìš´ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  
ìºì‹œëœ ê°ì²´ë¥¼ ë°˜í™˜í•˜ë©°, Hibernate ìºì‹œì˜ ê¸°ë³¸ ë™ì‘ ë°©ì‹ì´ë‹¤

ê·¸ëŸ¬ë‚˜ querydslì—ì„œëŠ” JPQLê³¼ ë‹¤ë¥´ê²Œ ì—”í‹°í‹° ê°ì²´ë¥¼ ì§ì ‘ì ìœ¼ë¡œ ì¡°íšŒí•œë‹¤.
ì´ ê²½ìš°, HibernateëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ìš°íšŒí•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì§ì ‘ ê°ì²´ë¥¼ ì¡°íšŒí•˜ê²Œëœë‹¤.
ë•Œë¬¸ì—, ì´ì „ì— ìºì‹œëœ ì—”í‹°í‹° ê°ì²´ê°€ ìµœì‹  ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœì™€ ì¼ì¹˜í•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ DTOë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤.

### ì™œ DTOë¥¼ ì‚¬ìš©í•´ì•¼í•˜ëŠ”ê°€?

**1. í•„ìš”í•œ í•„ë“œë§Œ ì„ íƒí•  ìˆ˜ ìˆìŒ**

- DTOë¥¼ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹°ì˜ ëª¨ë“  í•„ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ëŒ€ì‹  í•„ìš”í•œ í•„ë“œë§Œ ì„ íƒí•˜ì—¬ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤. 
- ì´ë ‡ê²Œ í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¶ˆí•„ìš”í•œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ì•Šì•„ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ê³¼ ë°ì´í„°ë² ì´ìŠ¤ ë¶€í•˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆëŠ” ì¥ì ì´ ì¡´ì¬.

**2. ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ëª…í™•í•˜ê²Œ ì •ì˜í•  ìˆ˜ ìˆìŒ**

- DTOëŠ” ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ëª…í™•í•˜ê²Œ ì •ì˜í•  ìˆ˜ ìˆë‹¤. ì—”í‹°í‹°ë¥¼ ì§ì ‘ ì¡°íšŒí•  ë•ŒëŠ” ì¿¼ë¦¬ ê²°ê³¼ê°€ ì—”í‹°í‹°ì™€ ê´€ë ¨ëœ ëª¨ë“  í•„ë“œë¥¼ ë°˜í™˜í•œë‹¤.
- í•˜ì§€ë§Œ, ì´ëŠ” ì˜ë„í•˜ì§€ ì•Šì€ ë°ì´í„° ë…¸ì¶œì„ ì´ˆë˜í•  ìˆ˜ ìˆê³  ë¶ˆí•„ìš”í•œ ë°ì´í„° ë˜í•œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
- DTOë¥¼ ì‚¬ìš©í•˜ë©´ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ëª…í™•í•˜ê²Œ ì •ì˜í•˜ì—¬ ì˜ë„í•œ í•„ë“œë§Œ ë°˜í™˜í•˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.

**3. ì—”í‹°í‹° ë³€ê²½ì— ëŒ€í•œ ì˜í–¥ì„ ì¤„ì¼ ìˆ˜ ìˆìŒ**

- DTOë¥¼ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹°ë¥¼ ë³€ê²½í•˜ë”ë¼ë„ DTOì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.
- ì—”í‹°í‹°ë¥¼ ë³€ê²½í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ëª¨ë“  ì¿¼ë¦¬ì˜ ê²°ê³¼ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆì§€ë§Œ DTOë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° DTOë¥¼ Entityí™” ì‹œí‚¤ëŠ” ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ì—¬ ì£¼ë©´ ëœë‹¤. 
- DTOë¥¼ ì‚¬ìš©í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ì¿¼ë¦¬ì˜ ê²°ê³¼ì—ë§Œ ì˜í–¥ì„ ì£¼ê¸° ë•Œë¬¸ì— ì—”í‹°í‹° ë³€ê²½ì— ë”°ë¥¸ ì˜í–¥ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

**4. ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•œ ì¶”ê°€ì ì¸ ì‘ì—… ê°€ëŠ¥**

- DTOë¥¼ ì‚¬ìš©í•˜ë©´ ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•´ ì¶”ê°€ì ì¸ ì‘ì—…ì„ í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, DTOì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” í•„ë“œë¥¼ ì œê±°í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ì˜ ì„±ëŠ¥ì„ ê°œì„ í•˜ê±°ë‚˜,
DTOì— ëŒ€í•œ ìºì‹œë¥¼ ì ìš©í•˜ì—¬ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

### GroupByë¥¼ í†µí•œ ìµœì í™” (Main.1-8)
Mysql í™˜ê²½(MariaDB)ì—ì„œ GroupBy ì‹¤í–‰ì‹œ ë°˜ë“œì‹œ Filesortê°€ ë°œìƒí•œë‹¤.(í•´ë‹¹ ì¿¼ë¦¬ê°€ indexë¥¼ íƒ€ì§€ ì•Šì•˜ì„ê²½ìš°)

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `order by`ì ˆì— nullì„ ì‚¬ìš©í•˜ë©´ FileSort ì‹œê°„ì„ ì œê±°í•˜ì—¬ ìµœì í™” ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”ë°, queryDslì€ ì•„ì‰½ê²Œë„ order by nullì´ ì§€ì›ë˜ì§€ ì•ŠëŠ”ë‹¤.

í•˜ì§€ë§Œ order by nullì„ ì§ì ‘ ì½”ë“œë¡œ êµ¬í˜„í•˜ì—¬ ì‚¬ìš©í•œë‹¤ë©´ queryDslì—ì„œë„ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

**ì¡°ê±´ í´ë˜ìŠ¤ ì‘ì„± ì˜ˆì‹œ**
![img.png](img/orderbynull.png)

### ë§Œì•½ ì •ë ¬ ì‘ì—…ì´ í•„ìš”í•  ê²½ìš°? (Main. 1-8-1)
ì •ë ¬ ì‘ì—…ì´ í•„ìš”í•œ ë°ì´í„°ì¸ ê²½ìš° ì¡°íšŒ ê²°ê³¼ê°€ 100ê±´ ì´í•˜ë¼ë©´, DBë³´ë‹¤ëŠ” Wasê°€ ì—¬ìœ ê°€ ìˆëŠ” í¸ì´ê¸°ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì •ë ¬í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤.

ë‹¨, í˜ì´ì§•ì˜ ê²½ìš° order by nullì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.


### ì»¤ë²„ë§ ì¸ë±ìŠ¤ (Main.1-9)

ì»¤ë²„ë§ ì¸ë±ìŠ¤ë¼ëŠ” ìš©ì–´ëŠ” í•„ìì˜ ê²½ìš° ì²˜ìŒ ì ‘í•˜ê²Œë˜ì—ˆë‹¤.

> ğŸ’¡ ì»¤ë²„ë§ ì¸ë±ìŠ¤(Covering Index)
> 
> ì¿¼ë¦¬ë¥¼ ì¶©ì¡±í•˜ëŠ”ë° í•„ìš”í•œ ëª¨ë“  ì»¬ëŸ¼ì„ ê°–ê³  ìˆëŠ” ì¸ë±ìŠ¤ë¥¼ ëœ»í•œë‹¤.
> 
> select/where/order by/group by ë“±ì—ì„œ ì‚¬ìš©ë˜ëŠ” ëª¨ë“  ì»¬ëŸ¼ì´ ì¸ë±ìŠ¤ì— í¬í•¨ëœ ìƒíƒœë¥¼ ëœ»í•œë‹¤.
> 
> NoOffset ë°©ì‹ê³¼ ë”ë¶ˆì–´ í˜ì´ì§• ì¡°íšŒ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ëŠ” ë³´í¸ì ì¸ ë°©ë²•

ì»¤ë²„ë§ ì¸ë±ìŠ¤ë¥¼ queryDslì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„  PKë¥¼ ì»¤ë²„ë§ ì¸ë±ìŠ¤ë¡œ ë¹ ë¥´ê²Œ ì¡°íšŒí•œë’¤, ì¡°íšŒëœ Keyë¡œ Select ì»¬ëŸ¼ì„ ì¡°íšŒí•œë‹¤.

## ì„±ëŠ¥ê°œì„  update/insert (Main.2)

### ì¼ê´„ update ìµœì í™”(Main.2-1)
ê¸°ì¡´ì— Entityì˜ í•„ë“œê°’ì„ ìˆ˜ì •í•˜ê¸° ìœ„í•´ì„  `DirtyChecking`ì„ ë§ì´ ì‚¬ìš©í•œë‹¤.

* DirtyChecking
  - Transaction ë‚´ë¶€ì—ì„œ Entityë¥¼ ì¡°íšŒí•˜ì—¬, í•´ë‹¹ Entityì˜ ê°’ì„ ë³€ê²½í•˜ì—¬ DBì— ë°˜ì˜í•˜ëŠ” ê²ƒì„ ë§í•œë‹¤.

ìš°ë¦¬ëŠ” ì´ ê³¼ì •ì—ì„œ ê°ì²´ ì§€í–¥ì„ í•‘ê³„ë¡œ ì„±ëŠ¥ì„ ë²„ë¦¬ì§€ ì•ŠëŠ”ì§€, **ë¬´ë¶„ë³„í•œ DirtyChecking**ì„ ê¼­ í™•ì¸í•´ë´ì•¼í•œë‹¤.

### ì¼ê´„ Updateì˜ ë‹¨ì  (Main.2-1-1)
í•˜ì´ë²„ë„¤ì´íŠ¸ ìºì‹œ(1ì°¨,2ì°¨ ìºì‹œ)ê°€ ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹œì— ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹œì— ìºì‹œ ê°±ì‹ ì´ ì•ˆëœë‹¤.

í•´ë‹¹ ê²½ìš° ì—…ë°ì´íŠ¸ ëŒ€ìƒë“¤ì— ëŒ€í•œ `Cache Eviction`ì´ í•„ìš”ë¡œëœë‹¤.

ê·¸ë˜ì„œ ì´ 2ê°€ì§€ Caseë¡œ ë¶„ë¥˜ë¥¼ í•  ìˆ˜ ìˆê²Œëœë‹¤.

- DirtyChecking : ì‹¤ì‹œê°„ ë¹„ì¦ˆë‹ˆìŠ¤ ì²˜ë¦¬, ì‹¤ì‹œê°„ ë‹¨ê±´ ì²˜ë¦¬
- Querydsl.update : ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ì¼ê´„ë¡œ Update ì²˜ë¦¬

ë˜í•œ ì§„ì§œ Entityê°€ í•„ìš”í•œê²ƒì´ ì•„ë‹ˆë¼ë©´, queryDslê³¼ DTOë¥¼ í†µí•´, ë”± í•„ìš”í•œ í•­ëª©ë“¤ê³¼ ì¡°íšŒí•˜ê³  ì—…ë°ì´íŠ¸í•œë‹¤.

### Bulk Insert(Main.2-2)
JPAì˜ ê²½ìš° PKê°€ AIì¼ ê²½ìš° Bulk Insertê°€ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.
